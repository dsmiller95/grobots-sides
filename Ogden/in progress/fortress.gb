#side The Fortress
#author Ogden
#color 767
#seed 3 4 1 1 2 1 2 1 2

#code

cluster-center: ; -- x y
	0 0 0
	do
		robot-position v+
		rot 1 + rrot
	next-robot while-loop
	rot vs/
return

wait-for-message: ; channel -- message
	do
		dup receive if
			0
		else
			1
		then
	while-loop
	rot drop
return

#type Peasant
#hardware
processor 2
solar-cells .4
constructor .4
energy 15 1
syphon 0.2 15
armor 25

#code
#vector barracks
#var help 0

2 wait-for-message barracks!

do
	; update
	2 receive if
		barracks!
	then
	3 receive if
		help!
	then
	; supply
	help if
		barracks position v- rect-to-polar syphon-direction! syphon-distance!
		syphon-max-rate negate syphon-rate!
	else
		0 syphon-rate!
	then
	; reproduce
	energy 5 >= if
		constructor-progress nif
			0.7 1 balance-type
			0.2 2 balance-type
			; just one of each of these
			epsilon 3 balance-type
			epsilon 4 balance-type
		then
		constructor-max-rate constructor-rate!
	then
forever

#type Archer
#color FFF
#decoration 00F square
#hardware
processor 10
engine 0.03
solar-cells 0.05
energy 50 15
syphon 0.5 15
armor 200
grenades 25 15 15
robot-sensor 15 1

#code
#vector center
#vector barracks

1 wait-for-message center!
2 wait-for-message barracks!

do
	; update
	1 receive if
		center!
	then
	2 receive if
		barracks!
	then
	; get to the wall
	friendly-collision if
		position center v- engine-velocity!
		engine-max-power engine-power!
	else
		0 engine-power!
	then
	; keep guard
	44 periodic-robot-sensor drop
	robot-found if
		robot-position robot-velocity lead-grenade
	then
	; resupply
	energy max-energy / 0.3 < if
		barracks position v- rect-to-polar syphon-direction! syphon-distance!
		syphon-max-rate syphon-rate!
	else
		0 syphon-rate!
	then
forever

#type Lord
#decoration FF0 cross
#hardware
processor 10
solar-cells 0.025
energy 7 7
armor 10
robot-sensor 30 200

#code
1 robot-sensor-sees-friends!
0 robot-sensor-sees-enemies!
do
	; scan, calculate, and announce fortress centerpoint
	180 periodic-robot-sensor if
		cluster-center 2 1 send
	then
forever

#type Barracks
#decoration F00 backslash
#hardware
processor 2
energy 2000 1
solar-cells 0.1
armor 75

#code
#var help 0
0
do
	; announce position
	1 + dup > 50 if
		position 2 2 send
		drop
		0
	then
	; ask for emergency resupply if low
	energy 250 < if
		1 1 3 send
		1 help!
	else
		help if
			0 1 3 send
			0 help!
		then
	then
forever

#end
